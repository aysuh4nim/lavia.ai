<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lavia ile Sohbet</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: 'Segoe UI', sans-serif;
        background-color: #000;
      }
      canvas {
        display: block;
      }

      /* Chat Bubble */
      .chat-bubble {
        position: absolute;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 15px 25px;
        border-radius: 20px;
        font-size: 18px;
        max-width: 60%;
        text-align: center;
        font-family: 'Segoe UI', sans-serif;
      }

      /* Microphone Button */
      #micButton {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 16px;
        font-size: 22px;
        border: none;
        border-radius: 50%;
        background: #31abc9;
        color: white;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        transition: background 0.3s ease;
      }

      #micButton:hover {
        background: #2499b2;
      }
    </style>

    <!-- Importmap - Three.js mod√ºl yollarƒ± -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.1/examples/jsm/"
        }
      }
    </script>
  </head>

  <body class="chat-page">
    <div class="chat-container">
      <canvas id="laviaCanvas"></canvas>
      <div class="chat-bubble" id="chatBubble">Merhaba! Konu≈ümak i√ßin mikrofon simgesine bas.</div>
      <button id="micButton">üéôÔ∏è</button>
    </div>

    <script type="module">
      import * as THREE from 'three';
      import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

      // Canvas ve Scene ayarlarƒ±
      const canvas = document.getElementById('laviaCanvas');
      const scene = new THREE.Scene();

      const camera = new THREE.PerspectiveCamera(
        45,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );
      camera.position.set(0, 1.6, 3);

      const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);

      // I≈üƒ±k ekleme
      const light = new THREE.DirectionalLight(0xffffff, 1);
      light.position.set(0, 5, 5);
      scene.add(light);

      const ambient = new THREE.AmbientLight(0x404040, 2);
      scene.add(ambient);

      // Lavia modelini y√ºkleme
      const loader = new GLTFLoader();
      loader.load(
        './lavia/laviaModel.glb',
        function (gltf) {
          console.log('‚úÖ Lavia modeli y√ºklendi:', gltf);

          // Modelin pozisyonunu ayarlama
          gltf.scene.position.y = 0.9;

          scene.add(gltf.scene);
        },
        function (xhr) {
          console.log(`Y√ºkleniyor: ${Math.round((xhr.loaded / xhr.total) * 100)}%`);
        },
        function (error) {
          console.error('‚ùå Lavia modeli y√ºklenemedi:', error);
        }
      );

      // Animasyon fonksiyonu
      function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
      }
      animate();

      // Pencere boyutu deƒüi≈üirse, renderer'ƒ± ve kamerayƒ± ayarla
      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });

      // Sohbet ba≈ülatma ve durdurma
      const micButton = document.getElementById('micButton');
      const chatBubble = document.getElementById('chatBubble');
      let isChatting = false;

      micButton.onclick = () => {
        if (isChatting) {
          stopChat();
        } else {
          startChat();
        }
      };

      function startChat() {
        // ƒ∞lk mesaj: Lavia'nƒ±n mesajƒ±
        chatBubble.textContent = "Lavia: Merhaba! Ben Lavia, seninle sohbet etmek i√ßin buradayƒ±m.";
        isChatting = true;
        micButton.textContent = "üõë Sohbeti Kapat"; // Buton metnini deƒüi≈ütir
        startVoiceRecognition(); // Sesli yanƒ±t ba≈ülat
      }

      function stopChat() {
        chatBubble.textContent = "Lavia: G√∂r√º≈ümek √ºzere!";
        isChatting = false;
        micButton.textContent = "üéôÔ∏è Sohbete Ba≈üla"; // Buton metnini eski haline d√∂nd√ºr
      }

      // Ses tanƒ±ma ba≈ülatma
      function startVoiceRecognition() {
        if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
          chatBubble.textContent = "Bu tarayƒ±cƒ± ses tanƒ±mayƒ± desteklemiyor!";
        } else {
          const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
          recognition.lang = 'tr-TR';
          recognition.interimResults = true;

          recognition.start();
          chatBubble.textContent = "Dinliyorum...";

          recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            chatBubble.textContent = `Sonu√ß: ${transcript}`;
            sendToOpenAI(transcript); // OpenAI API'ye g√∂nder
          };

          recognition.onerror = (event) => {
            chatBubble.textContent = `Hata: ${event.error}`;
          };
        }
      }

      // OpenAI API'ye metni g√∂nderme
      function sendToOpenAI(text) {
        fetch('/api/openai.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: text, model: 'gpt-4', max_tokens: 150 }),
        })
          .then((response) => response.json())
          .then((data) => {
            const answer = data.choices[0].text;
            speakAnswer(answer); // OpenAI yanƒ±tƒ±nƒ± sesli okutma
          })
          .catch((error) => {
            console.error("OpenAI API hatasƒ±:", error);
          });
      }

      // OpenAI yanƒ±tƒ±nƒ± sesli okutma
      function speakAnswer(answer) {
        const speech = new SpeechSynthesisUtterance(answer);
        window.speechSynthesis.speak(speech);
      }
    </script>
  </body>
</html>

