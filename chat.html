<script type="module">
  import * as THREE from 'three';
  import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

  // Canvas ve Scene ayarları
  const canvas = document.getElementById('laviaCanvas');
  const scene = new THREE.Scene();

  const camera = new THREE.PerspectiveCamera(
    45,
    window.innerWidth / window.innerHeight,
    0.1,
    1000
  );
  camera.position.set(0, 1.6, 3);

  const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio);

  // Işık ekleme
  const light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(0, 5, 5);
  scene.add(light);

  const ambient = new THREE.AmbientLight(0x404040, 2);
  scene.add(ambient);

  // Lavia modelini yükleme
  const loader = new GLTFLoader();
  loader.load(
    './lavia/laviaModel.glb',
    function (gltf) {
      console.log('✅ Lavia modeli yüklendi:', gltf);

      // Modelin pozisyonunu ayarlama
      gltf.scene.position.y = 0.9;

      scene.add(gltf.scene);
    },
    function (xhr) {
      console.log(`Yükleniyor: ${Math.round((xhr.loaded / xhr.total) * 100)}%`);
    },
    function (error) {
      console.error('❌ Lavia modeli yüklenemedi:', error);
    }
  );

  // Animasyon fonksiyonu
  function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
  }
  animate();

  // Pencere boyutu değişirse, renderer'ı ve kamerayı ayarla
  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  // Sohbet başlatma ve durdurma
  const micButton = document.getElementById('micButton');
  const chatBubble = document.getElementById('chatBubble');
  let isChatting = false;

  micButton.onclick = () => {
    if (isChatting) {
      stopChat();
    } else {
      startChat();
    }
  };

  function startChat() {
    chatBubble.textContent = "Lavia: Merhaba! Ben Lavia, seninle sohbet etmek için buradayım.";
    isChatting = true;
    micButton.textContent = "🛑 Sohbeti Kapat"; 
    startVoiceRecognition(); 
  }

  function stopChat() {
    chatBubble.textContent = "Lavia: Görüşmek üzere!";
    isChatting = false;
    micButton.textContent = "🎙️ Sohbete Başla"; 
  }

  function startVoiceRecognition() {
    if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
      chatBubble.textContent = "Bu tarayıcı ses tanımayı desteklemiyor!";
    } else {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'tr-TR';
      recognition.interimResults = true;

      recognition.start();
      chatBubble.textContent = "Dinliyorum...";

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        chatBubble.textContent = `Sonuç: ${transcript}`;
        sendToOpenAI(transcript); 
      };

      recognition.onerror = (event) => {
        chatBubble.textContent = `Hata: ${event.error}`;
      };
    }
  }

  function sendToOpenAI(text) {
    // Sunucuya yapılan istek loglanabilir
    console.log('OpenAI API isteği gönderiliyor...');
    
    fetch('https://lavia-ai.onrender.com/api/openai', {  
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt: text, model: 'gpt-4', max_tokens: 150 }),
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error('API yanıtı alınamadı');
        }
        return response.json();  
      })
      .then((data) => {
        console.log('API Yanıtı:', data); // Burada gelen yanıtı logluyoruz
        if (data && data.reply) {  
          const answer = data.reply;  
          speakAnswer(answer);  
        } else {
          throw new Error('Geçersiz veri formatı');  
        }
      })
      .catch((error) => {
        console.error("OpenAI API hatası:", error);
        chatBubble.textContent = "Bir şeyler ters gitti, lütfen tekrar deneyin.";  
      });
  }

  function speakAnswer(answer) {
    const speech = new SpeechSynthesisUtterance(answer);
    window.speechSynthesis.speak(speech);
  }
</script>
